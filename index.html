<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CV Scoring System - Detailed Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.8);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: rgba(148, 163, 184, 0.2);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--primary);
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 10px;
            color: var(--primary);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 30px;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.3rem;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .required {
            color: var(--danger);
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(15, 23, 42, 0.8);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .file-upload {
            position: relative;
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(15, 23, 42, 0.4);
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .file-upload input {
            display: none;
        }

        .file-upload-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .file-name {
            margin-top: 10px;
            color: var(--success);
            font-size: 0.9rem;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results {
            display: none;
        }

        .results.visible {
            display: block;
        }

        .score-header {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .score-circle {
            width: 180px;
            height: 180px;
            margin: 0 auto 20px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .score-value {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .score-label {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 10px;
        }

        .recommendation {
            display: inline-block;
            padding: 10px 20px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--success);
            border-radius: 8px;
            color: var(--success);
            font-weight: 600;
            margin-top: 15px;
        }

        .recommendation.warning {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--warning);
            color: var(--warning);
        }

        .recommendation.danger {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
            color: var(--danger);
        }

        .breakdown {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .breakdown-item {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .breakdown-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .breakdown-score {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }

        .breakdown-details {
            display: grid;
            gap: 12px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .detail-score {
            font-weight: 600;
            color: var(--text-primary);
        }

        .detail-explanation {
            margin-top: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .strengths-weaknesses {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .strengths-weaknesses {
                grid-template-columns: 1fr;
            }
        }

        .sw-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .sw-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sw-list {
            list-style: none;
        }

        .sw-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .sw-list li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 8px;
            font-size: 1.2rem;
        }

        .sw-list.strengths li:before {
            color: var(--success);
        }

        .sw-list.weaknesses li:before {
            color: var(--danger);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .loading-time {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .progress-steps {
            margin-top: 30px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 8px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            padding: 8px 0;
            color: var(--text-secondary);
        }

        .progress-step.active {
            color: var(--primary);
            font-weight: 600;
        }

        .progress-step.completed {
            color: var(--success);
        }

        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 0.7rem;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 8px;
            padding: 15px;
            color: var(--danger);
            margin-top: 15px;
            display: none;
        }

        .error.visible {
            display: block;
        }

        .info-box {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        footer {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI CV Scoring System</h1>
            <p class="subtitle">Detailed Explainable Candidate Analysis</p>
            <span class="badge">100-Point Hybrid Scoring</span>
        </header>

        <!-- Observability Metrics -->
        <div class="card" id="metrics-card" style="margin: 20px 0; display: none;">
            <div class="card-header">
                <div class="card-icon">üìà</div>
                <h2 class="card-title">Observability Metrics</h2>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                <div class="obs-metric"><strong>Requests</strong><div id="totalRequestsValue">0</div></div>
                <div class="obs-metric"><strong>Successful</strong><div id="successValue">0</div></div>
                <div class="obs-metric"><strong>Errors</strong><div id="errorsValue">0</div></div>
                <div class="obs-metric"><strong>Avg latency</strong><div id="latencyValue">~0s</div></div>
                <div class="obs-metric"><strong>Avg cost</strong><div id="costValue">$0.00</div></div>
                <div class="obs-metric"><strong>Status</strong><div id="statusValue">Offline</div></div>
            </div>
        </div>

        <div class="main-content">
            <!-- CV Upload Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üìÑ</div>
                    <h2 class="card-title">Upload CV</h2>
                </div>

                <div class="form-group">
                    <label for="cv-upload">CV File <span class="required">*</span></label>
                    <div class="file-upload" onclick="document.getElementById('cv-upload').click()">
                        <input type="file" id="cv-upload" accept=".pdf,.txt">
                        <div class="file-upload-icon">üìÅ</div>
                        <div>Click to upload or drag & drop</div>
                        <small style="color: var(--text-secondary); margin-top: 5px; display: block;">PDF or TXT (max 5MB)</small>
                        <div class="file-name" id="file-name"></div>
                    </div>
                </div>

                <div class="info-box">
                    <strong>Tip:</strong> Make sure your CV includes skills, experience, education, and projects for best results.
                </div>
            </div>

            <!-- Job Details Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üíº</div>
                    <h2 class="card-title">Job Details</h2>
                </div>

                <div class="form-group">
                    <label for="job-title">Job Title <span class="required">*</span></label>
                    <input type="text" id="job-title" placeholder="e.g., Senior Python Developer" required>
                </div>

                <div class="form-group">
                    <label for="company">Company <span class="required">*</span></label>
                    <input type="text" id="company" placeholder="e.g., Tech Innovators Inc." required>
                </div>

                <div class="form-group">
                    <label for="industry">Industry</label>
                    <select id="industry">
                        <option value="">Select industry...</option>
                        <option value="fintech">FinTech</option>
                        <option value="gambling">Gambling/iGaming</option>
                        <option value="health">Healthcare</option>
                        <option value="tech">Technology</option>
                        <option value="ecommerce">E-commerce</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" placeholder="e.g., Paris / Remote" value="Remote">
                </div>

                <div class="form-group">
                    <label for="salary">Salary (‚Ç¨)</label>
                    <input type="number" id="salary" placeholder="e.g., 130000">
                </div>
            </div>
        </div>

        <!-- Job Description Section -->
        <div class="card" style="margin-bottom: 30px;">
            <div class="card-header">
                <div class="card-icon">üìã</div>
                <h2 class="card-title">Job Requirements</h2>
            </div>

            <div class="form-group">
                <label for="description">Job Description <span class="required">*</span></label>
                <textarea id="description" placeholder="Paste the full job description here..." rows="6" required></textarea>
            </div>

            <div class="form-group">
                <label for="requirements">Required Skills (comma-separated) <span class="required">*</span></label>
                <input type="text" id="requirements" placeholder="e.g., Python, Docker, SQL, FastAPI, Kubernetes" required>
            </div>

            <button class="btn btn-primary" id="analyze-btn" onclick="analyzeCandidate()">
                <span>üîç</span>
                <span>Analyze Candidate</span>
            </button>

            <div class="error" id="error-message"></div>
        </div>

        <!-- Loading State -->
        <div class="card loading" id="loading-section">
            <div class="spinner"></div>
            <div class="loading-text">Analyzing candidate profile...</div>
            <div class="loading-time">This will take approximately 50-60 seconds</div>

            <div class="progress-steps">
                <div class="progress-step" id="step-1">
                    <div class="step-icon">1</div>
                    <span>Deterministic Scoring (Skills, Experience, Education)</span>
                </div>
                <div class="progress-step" id="step-2">
                    <div class="step-icon">2</div>
                    <span>Semantic Analysis (Soft Skills, Culture Fit)</span>
                </div>
                <div class="progress-step" id="step-3">
                    <div class="step-icon">3</div>
                    <span>Bonus Scoring (Industry Experience, Rare Skills)</span>
                </div>
                <div class="progress-step" id="step-4">
                    <div class="step-icon">4</div>
                    <span>Generating Detailed Report</span>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results" id="results-section">
            <!-- Score Header -->
            <div class="score-header">
                <div class="score-circle">
                    <div class="score-value" id="total-score">--</div>
                </div>
                <div class="score-label">Overall Match Score</div>
                <div class="recommendation" id="recommendation">--</div>
            </div>

            <!-- Score Breakdown -->
            <div class="breakdown" id="breakdown-section">
                <!-- Will be populated dynamically -->
            </div>

            <!-- Strengths & Weaknesses -->
            <div class="strengths-weaknesses">
                <div class="sw-section">
                    <div class="sw-title">
                        <span>‚úÖ</span>
                        <span>Strengths</span>
                    </div>
                    <ul class="sw-list strengths" id="strengths-list">
                        <!-- Will be populated dynamically -->
                    </ul>
                </div>

                <div class="sw-section">
                    <div class="sw-title">
                        <span>‚ö†Ô∏è</span>
                        <span>Areas for Improvement</span>
                    </div>
                    <ul class="sw-list weaknesses" id="weaknesses-list">
                        <!-- Will be populated dynamically -->
                    </ul>
                </div>
            </div>

            <!-- Overall Explanation -->
            <div class="card" style="margin-top: 30px;">
                <div class="card-header">
                    <div class="card-icon">üí°</div>
                    <h2 class="card-title">Overall Analysis</h2>
                </div>
                <p id="overall-explanation" style="line-height: 1.8; color: var(--text-secondary);"></p>
            </div>
        </div>

        <footer>
            <p>AI CV Scoring System - Powered by Claude AI</p>
            <p style="margin-top: 5px;">Hybrid Scoring: 40pts Deterministic + 40pts Semantic + 20pts Bonus</p>
        </footer>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';

        // File upload handling
        document.getElementById('cv-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('file-name').textContent = `‚úì ${file.name}`;
            }
        });

        let currentStep = 0;

        function updateProgressStep(step) {
            currentStep = step;
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                if (i < step) {
                    stepEl.classList.add('completed');
                    stepEl.classList.remove('active');
                } else if (i === step) {
                    stepEl.classList.add('active');
                    stepEl.classList.remove('completed');
                } else {
                    stepEl.classList.remove('active', 'completed');
                }
            }
        }

        async function analyzeCandidate() {
            // Validate inputs
            const cvFile = document.getElementById('cv-upload').files[0];
            // jobTitle can come from replaced select (offer-select) or from a hidden field if an offer was selected
            let jobTitle = '';
            const hiddenTitle = document.getElementById('job-title-hidden');
            const offerSelect = document.getElementById('offer-select');
            const jobTitleInput = document.getElementById('job-title');
            if (hiddenTitle) jobTitle = hiddenTitle.value.trim();
            else if (offerSelect && offerSelect.value) {
                // if an offer is selected, try to get its text
                jobTitle = offerSelect.options[offerSelect.selectedIndex].text.split(' ‚Äî ')[0].trim();
            } else if (jobTitleInput) jobTitle = jobTitleInput.value.trim();
            const company = document.getElementById('company').value.trim();
            const description = document.getElementById('description').value.trim();
            const requirements = document.getElementById('requirements').value.trim();

            if (!cvFile) {
                showError('Please upload a CV file');
                return;
            }

            if (!jobTitle || !company || !description || !requirements) {
                showError('Please fill in all required fields');
                return;
            }

            // Hide error and results
            document.getElementById('error-message').classList.remove('visible');
            document.getElementById('results-section').classList.remove('visible');

            // Show loading
            document.getElementById('loading-section').style.display = 'block';
            document.getElementById('analyze-btn').disabled = true;
            updateProgressStep(1);

            // Simulate progress updates
            setTimeout(() => updateProgressStep(2), 5000);
            setTimeout(() => updateProgressStep(3), 20000);
            setTimeout(() => updateProgressStep(4), 40000);

            // Prepare form data
            const formData = new FormData();
            formData.append('resume_file', cvFile);
            formData.append('job_title', jobTitle);
            formData.append('company', company);
            formData.append('industry', document.getElementById('industry').value);
            formData.append('location', document.getElementById('location').value);
            formData.append('salary', document.getElementById('salary').value);
            formData.append('description', description);
            formData.append('requirements', requirements);

            try {
                const response = await fetch(`${API_URL}/api/detailed-score`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to analyze candidate');
                }

                const result = await response.json();
                displayResults(result);

            } catch (error) {
                showError(error.message);
                document.getElementById('loading-section').style.display = 'none';
            } finally {
                document.getElementById('analyze-btn').disabled = false;
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.add('visible');
        }

        function displayResults(data) {
            // Hide loading
            document.getElementById('loading-section').style.display = 'none';

            // Show results
            document.getElementById('results-section').classList.add('visible');

            // Scroll to results
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });

            // Display total score
            document.getElementById('total-score').textContent = Math.round(data.match_score);

            // Display recommendation
            const recEl = document.getElementById('recommendation');
            recEl.textContent = data.recommendation;

            // Set recommendation color
            recEl.className = 'recommendation';
            if (data.match_score >= 75) {
                recEl.classList.add('success');
            } else if (data.match_score >= 50) {
                recEl.classList.add('warning');
            } else {
                recEl.classList.add('danger');
            }

            // Display breakdowns
            displayBreakdowns(data.score_breakdown);

            // Display strengths
            const strengthsList = document.getElementById('strengths-list');
            strengthsList.innerHTML = '';
            data.strengths.forEach(strength => {
                const li = document.createElement('li');
                li.textContent = strength;
                strengthsList.appendChild(li);
            });

            // Display weaknesses
            const weaknessesList = document.getElementById('weaknesses-list');
            weaknessesList.innerHTML = '';
            data.weaknesses.forEach(weakness => {
                const li = document.createElement('li');
                li.textContent = weakness;
                weaknessesList.appendChild(li);
            });

            // Display overall explanation
            document.getElementById('overall-explanation').textContent = data.overall_explanation;
        }

        function displayBreakdowns(breakdown) {
            const breakdownSection = document.getElementById('breakdown-section');
            breakdownSection.innerHTML = '';

            // Deterministic
            const detCard = createBreakdownCard('Deterministic Score',
                breakdown.deterministic.total,
                breakdown.deterministic.max,
                breakdown.deterministic.details);
            breakdownSection.appendChild(detCard);

            // Semantic
            const semCard = createBreakdownCard('Semantic Score',
                breakdown.semantic.total,
                breakdown.semantic.max,
                breakdown.semantic.details);
            breakdownSection.appendChild(semCard);

            // Bonus
            const bonusCard = createBreakdownCard('Bonus Score',
                breakdown.bonus.total,
                breakdown.bonus.max,
                breakdown.bonus.details);
            breakdownSection.appendChild(bonusCard);
        }

        function createBreakdownCard(title, score, max, details) {
            const card = document.createElement('div');
            card.className = 'breakdown-item';

            const header = document.createElement('div');
            header.className = 'breakdown-header';
            header.innerHTML = `
                <div class="breakdown-title">${title}</div>
                <div class="breakdown-score">${score.toFixed(1)}/${max}</div>
            `;

            const detailsContainer = document.createElement('div');
            detailsContainer.className = 'breakdown-details';

            // Add each detail
            for (const [key, value] of Object.entries(details)) {
                if (typeof value === 'object' && value.score !== undefined) {
                    const detailRow = document.createElement('div');
                    detailRow.className = 'detail-row';

                    const label = formatLabel(key);
                    detailRow.innerHTML = `
                        <div>
                            <div class="detail-label">${label}</div>
                            <div class="detail-explanation">${value.explanation || ''}</div>
                        </div>
                        <div class="detail-score">${value.score.toFixed(1)}/${value.max}</div>
                    `;

                    detailsContainer.appendChild(detailRow);
                }
            }

            card.appendChild(header);
            card.appendChild(detailsContainer);

            return card;
        }

        function formatLabel(key) {
            return key
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        // Check backend health on load
        async function checkBackendHealth() {
            try {
                const response = await fetch(`${API_URL}/api/health`);
                if (response.ok) {
                    console.log('Backend is online');
                }
            } catch (error) {
                console.error('Backend is offline:', error);
                showError('Cannot connect to backend. Please make sure the server is running on http://localhost:8000');
            }
        }

        checkBackendHealth();
        // Load and poll observability metrics (restore UI from backup)
        async function loadMetrics() {
            try {
                const response = await fetch(`${API_URL}/api/metrics`);
                if (!response.ok) throw new Error('Failed to load metrics');
                const metrics = await response.json();

                // Ensure metrics card visible
                document.getElementById('metrics-card').style.display = 'block';

                document.getElementById('latencyValue').textContent = `~${metrics.avg_latency}s`;
                document.getElementById('successValue').textContent = metrics.successful_matches;
                document.getElementById('costValue').textContent = `$${metrics.avg_cost}`;
                document.getElementById('statusValue').textContent = metrics.status === 'online' ? 'Online' : 'Offline';
                document.getElementById('totalRequestsValue').textContent = metrics.total_requests;
                document.getElementById('errorsValue').textContent = metrics.errors;
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        // Poll metrics every 10s
        setInterval(loadMetrics, 10000);
        // initial load
        loadMetrics();

        // Load available job offers and replace job-title input with a dropdown
        async function loadOffers() {
            try {
                const res = await fetch(`${API_URL}/api/offers`);
                if (!res.ok) return;
                const offers = await res.json();

                const jobTitleEl = document.getElementById('job-title');
                const select = document.createElement('select');
                select.id = 'offer-select';
                select.innerHTML = '<option value="">S√©lectionner une offre...</option>';

                offers.forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o.id;
                    opt.textContent = `${o.title} ‚Äî ${o.company}`;
                    select.appendChild(opt);
                });

                // replace the job-title input with the select
                jobTitleEl.parentNode.replaceChild(select, jobTitleEl);

                select.addEventListener('change', async (e) => {
                    const id = parseInt(e.target.value);
                    if (!id) return;
                    const detRes = await fetch(`${API_URL}/api/offers/${id}`);
                    if (!detRes.ok) return;
                    const detail = await detRes.json();
                    // fill fields
                    // create a hidden job-title input to keep form expectations
                    let hidden = document.getElementById('job-title-hidden');
                    if (!hidden) {
                        hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.id = 'job-title-hidden';
                        document.querySelector('.card').appendChild(hidden);
                    }
                    hidden.value = detail.title || '';
                    // company
                    document.getElementById('company').value = detail.company || '';
                    // description
                    document.getElementById('description').value = detail.description || '';
                    // requirements
                    document.getElementById('requirements').value = (detail.requirements || []).join(', ');
                    // location & salary & industry
                    document.getElementById('location').value = detail.location || 'Remote';
                    document.getElementById('salary').value = detail.salary || '';
                    document.getElementById('industry').value = detail.industry || '';
                });

            } catch (error) {
                console.error('Error loading offers:', error);
            }
        }

        // initial load of offers
        loadOffers();
    </script>
</body>
</html>
