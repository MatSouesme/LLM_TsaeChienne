<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CV Scoring - Match Against Stored Offers</title>
    <style>
        /* Minimal styling copied from index.html for consistency */
        body { font-family: Arial, sans-serif; background:#0f172a; color:#f1f5f9; padding:20px }
        .container { max-width:1100px; margin:0 auto }
        .card { background: rgba(30,41,59,0.8); padding:20px; border-radius:10px; margin-bottom:16px }
        .btn { padding:12px 18px; border-radius:8px; background:#6366f1; color:white; border:none }
        .offer-card { background: rgba(15,23,42,0.6); padding:12px; border-radius:8px; margin-bottom:10px }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>Match CV against Stored Offers (Top-3)</h1>
            <a href="chat.html" style="text-decoration: none;">
                <button class="btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    ðŸ¤– Try Conversational Chat
                </button>
            </a>
        </div>

        <div class="card">
            <h3>Upload CV</h3>
            <input type="file" id="cv-upload" accept=".pdf,.txt">
            <div id="file-name" style="margin-top:8px;color:#10b981"></div>
        </div>

        <div class="card">
            <h3>Filters (optional)</h3>
            <label>Industry</label>
            <select id="industry">
                <option value="">Any</option>
                <option value="fintech">FinTech</option>
                <option value="gambling">Gambling/iGaming</option>
                <option value="health">Healthcare</option>
                <option value="tech">Technology</option>
                <option value="ecommerce">E-commerce</option>
            </select>
            <div style="height:8px"></div>
            <label>Location</label>
            <input type="text" id="location" placeholder="e.g. Paris or Remote">
            <div style="height:8px"></div>
            <label>Minimum Salary</label>
            <input type="number" id="salary" placeholder="e.g. 50000">
            <div style="height:12px"></div>
            <button class="btn" id="match-btn" onclick="matchAgainstOffers()">Match against offers</button>
        </div>

        <div class="card" id="loading" style="display:none">Analyzing... this may take some time.</div>

        <div id="results"></div>

    </div>

    <script>
        const API_URL = 'http://localhost:8001';

        document.getElementById('cv-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) document.getElementById('file-name').textContent = `âœ“ ${file.name}`;
        });

        async function matchAgainstOffers() {
            const file = document.getElementById('cv-upload').files[0];
            const industry = document.getElementById('industry').value;
            const location = document.getElementById('location').value;
            const salary = document.getElementById('salary').value;

            if (!file) { alert('Please upload a CV first'); return; }

            const fd = new FormData();
            fd.append('resume_file', file);
            if (industry) fd.append('industry', industry);
            if (location) fd.append('location', location);
            if (salary) fd.append('salary', salary);
            fd.append('max_offers', '50');
            fd.append('top_k', '3');

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';
            document.getElementById('match-btn').disabled = true;

            try {
                const res = await fetch(`${API_URL}/api/match_offers`, {
                    method: 'POST',
                    body: fd
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Match failed');
                }
                const data = await res.json();
                displayTopMatches(data);
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('match-btn').disabled = false;
            }
        }

        function displayTopMatches(data) {
            const container = document.getElementById('results');
            container.innerHTML = '';

            if (!data.matches || data.matches.length === 0) {
                container.innerHTML = '<div class="card">No matches found.</div>';
                return;
            }

            const meta = document.createElement('div');
            meta.className = 'card';
            meta.innerHTML = `<strong>Latency:</strong> ${data.metrics.latency}s â€” <strong>Cost:</strong> $${data.metrics.cost}`;
            container.appendChild(meta);

            data.matches.forEach(m => {
                const c = document.createElement('div');
                c.className = 'offer-card';
                const summary = (m.detail && m.detail.overall_explanation) ? m.detail.overall_explanation : '';
                c.innerHTML = `
                    <h4>${m.job_title} â€” ${m.company}</h4>
                    <div><strong>Score:</strong> ${Math.round(m.match_score)}</div>
                    <div><strong>Location:</strong> ${m.location || 'N/A'} â€” <strong>Salary:</strong> ${m.salary || 'N/A'}</div>
                    <p style="color:#94a3b8">${summary}</p>
                `;
                container.appendChild(c);
            });
        }
    </script>
</body>
</html>
